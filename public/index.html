<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.bootcdn.net/ajax/libs/axios/0.21.1/axios.js">
  </script>
  <title>网页触控板</title>
  <style type="text/css">
    * {
      margin: 0px;
      padding: 0px
    }

    body,html {
      overflow: hidden;
      width: 100%;
      height: 100%;
    }
    #can {
      position: fixed;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      user-select: none;
    }
    #toolbar {
      display: flex;
      position: fixed;
      left: 0;
      width: 100%;
      bottom: 0;
      height: 50px;
    }
    #toolbar input {
      flex: 1;
      height: 100%;
      font-size: 24px;
      line-height: 50px;
      min-width: 0;
    }
    #toolbar button {
      width: 60px;
      height: 100%;
      user-select: none;
    }
  </style>
</head>
<body>
  <canvas id="can"></canvas>
  <div id="toolbar">
    <input type="text" value="" />
    <button type="button">Send</button>
  </div>
  <script type="text/javascript">
    let sens = 4 // 滑动灵敏度
    let scrs = 2 // 滚动灵敏度
    const $ = document.querySelector.bind(document)
    const $$ = document.querySelectorAll.bind(document)
    let can = document.getElementById("can")
    let cvs = can.getContext("2d")
    can.width = window.innerWidth
    can.height = window.innerHeight
    let host = window.location.host

    let mx = 0
    let my = 0
    let sx = 0
    let sy = 0
    let x = 0
    let y = 0
    let flag = false
    let touchLength = 0
    let touchScroll = false

    can.addEventListener("touchstart", function (e) {
      touchLength = e.touches.length
      x = sx = e.touches[0].clientX
      y = sy = e.touches[0].clientY
      axios.get(`http://${host}/mouse/get/`)
        .then(res => {
          mx = parseInt(res.data.x)
          my = parseInt(res.data.y)
          flag = true
        })
    }, {
      passive: false
    })

    can.addEventListener("touchmove", function (e) {
      e.preventDefault()
      if (e.touches.length == 2) {
        touchScroll = true
        let tmpsx = (e.touches[0].clientX - sx) * scrs
        let tmpsy = (e.touches[0].clientY - sy) * scrs
        axios.post(`http://${host}/mouse/scroll/`, {
          x: tmpsx,
          y: tmpsy,
        })
        sx = e.touches[0].clientX
        sy = e.touches[0].clientY
      } else {
        if (!flag) return
        let tmpx = mx + (e.touches[0].clientX - x) * sens
        let tmpy = my + (e.touches[0].clientY - y) * sens
        axios.post(`http://${host}/mouse/move/`, {
          x: tmpx,
          y: tmpy,
        })

      }
    }, {
      passive: false
    })

    can.addEventListener("touchend", function (e) {
      if (touchLength == 2 && !touchScroll) {
        axios.post(`http://${host}/mouse/click/`, {
          button: 'right'
        })
      }
      touchLength = 0
      touchScroll = false
      flag = false
    }, {
      passive: false
    })

    can.addEventListener("click", function (e) {
      axios.post(`http://${host}/mouse/click/`, {
        button: 'left'
      })
    }, {
      passive: false
    })

    $("#toolbar button").addEventListener("click", function (e) {
      axios.post(`http://${host}/keyboard/input`, {
        value: $("#toolbar input").value
      })
    })
  </script>
</body>
</html>
